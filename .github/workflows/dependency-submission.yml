name: Dependency Submission

on:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  attestations: write
  artifact-metadata: write

jobs: 
  dependency-submission:
    runs-on:  ubuntu-latest
    steps: 
    - name: Checkout sources
      uses: actions/checkout@v4
      
    - name:  Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: 17
        
    # Make gradlew executable
    - name: Make gradlew executable
      run: chmod +x ./gradlew
        
    # Build with assemble (creates JARs without running tests)
    - name: Build with Gradle
      run: ./gradlew assemble --stacktrace
      
    # Submit dependencies to GitHub
    - name:  Generate and submit dependency graph
      uses: gradle/actions/dependency-submission@v4
      
    # Create output directory and copy artifacts
    - name:  Prepare artifacts for attestation
      run: |
        mkdir -p dist/my-app
        # Check if build directory exists
        if [ -d "build/libs" ]; then
          cp build/libs/*.jar dist/my-app/ 2>/dev/null || echo "No JARs in build/libs"
        fi
        # For multi-module projects
        find . -path "*/build/libs/*. jar" !  -path "*/test/*" -exec cp {} dist/my-app/ \; 2>/dev/null || true
        # Verify we have artifacts
        if [ -z "$(ls -A dist/my-app/*. jar 2>/dev/null)" ]; then
          echo "Error: No JAR files found to attest"
          exit 1
        fi
        echo "Artifacts to attest:"
        ls -la dist/my-app/
        
    # Generate SBOM
    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        path: dist/my-app
        artifact-name: sbom.spdx. json
        output-file: dist/my-app/sbom. spdx.json
        
    # Now attest the actual built artifacts
    - name: Attest Build Provenance
      uses: actions/attest-build-provenance@v3.1.0
      with:
        subject-path:  'dist/my-app/*. jar'
        
    - name: Attest SBOM
      uses: actions/attest-sbom@v3.0.0
      with:
        subject-path: 'dist/my-app/*.jar'
        sbom-path: 'dist/my-app/sbom.spdx.json'
        
    # Optional: Generic attestations
    - name: Generate Generic Attestations
      uses: actions/attest@v3.1.0
      with:
        subject-path: 'dist/my-app/*.jar'
        predicate-type: 'https://example.com/predicate/v1'
        predicate: '{}'
